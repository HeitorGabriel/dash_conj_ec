---
title: "Conjuntura Econômica (EM CONSTRUÇÃO):"

output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    storyboard: true
    theme:
      version: 4
      bootswatch: yeti
---

```{r setup, include=FALSE}
setwd('/home/heitor/ProjetosR/Shiny Porjects/Conjuntura/Conjt_board')

library(flexdashboard)
library(tidyverse)
library(plotly)
library(sidrar)
library(knitr)
library(kableExtra)
library(formattable)

# Coletas: =====================================
# ipca  - Br   reg - último mês - mensal e ac. ano
c1 <- '/t/7060/n1/all/n7/all/n6/all/v/63,69/p/last%201/c315/7169/d/v63%202,v69%202'
# ipca  - Br   reg - histórico - ac. 12 meses
c2 <- '/t/7060/n1/all/n7/all/n6/all/v/2265/p/all/c315/7169/d/v2265%202'
# ipca - br reg - último mês - peso mensal
c3 <- '/t/7060/n1/all/n7/all/n6/all/v/66/p/last%201/c315/7169,7170,7445,7486,7558,7625,7660,7712,7766,7786/d/v66%204'
# ipp - br - hist - mes, mes ant, ac ano, indc
c4 <- '/t/6904/n1/all/v/all/p/all/c543/33579,33580,33583,33585,33586/d/v1394%202,v1395%202,v1396%202,v10008%205'
c5 <- '/t/6903/n1/all/v/1394,1395,1396/p/last%201/c842/all/d/v1394%202,v1395%202,v1396%202'

# Tratamentos: ================================

## c1 ---
d1 <- get_sidra(api = c1) %>% as_tibble()

d1 <- d1 |>
	dplyr::select('Var' = 'Variável', 
				  'Mês',
				  'Valor',
				  'Local' = 'Brasil, Região Metropolitana e Município',
				  'Grupo' = 'Geral, grupo, subgrupo, item e subitem')

d1$Var <- stringr::str_replace(d1$Var,
					 pattern = 'IPCA - Variação ',
					 replacement = 'Var. ')
d1 <- d1 |> dplyr::mutate(Local,
						  'br' = case_when(
						  	Local=="Brasil"~'País',
						  	Local!='Brasil'~'RM'))
d1$br <- d1$br |> as_factor()

## c3 ---
d3 <- get_sidra(api = c3) %>% as_tibble()

d3 <- d3 |>
	dplyr::select('Valor',
				  'Local' = 'Brasil, Região Metropolitana e Município',
				  'Grupo' = 'Geral, grupo, subgrupo, item e subitem') |>
	dplyr::filter(!Grupo=='Índice geral') |>
	tidyr::pivot_wider(names_from = Grupo,
					   values_from = Valor)

## c2 ---
d2 <- get_sidra(api = c2) %>% as_tibble()

d2 <- d2 |>
	dplyr::select('Var' = 'Variável', 
				  'Mês' = "Mês (Código)",
				  'Valor',
				  'Local' = 'Brasil, Região Metropolitana e Município') |>
	dplyr::filter(!is.na(Valor))

d2$Var <- stringr::str_replace(d2$Var,
					 pattern = 'IPCA - Variação acumulada em',
					 replacement = 'Var. Ac.')

d2$Mês <- d2$Mês |> lubridate::ym()

## c4 ---
d4 <- get_sidra(api = c4) %>% as_tibble()

d4 <- d4 |>
	dplyr::select('Variável',
				  'Categoria' = 'Grandes categorias econômicas',
				  'Mês' = 'Mês (Código)',
				  'Valor'
				  ) |>
	pivot_wider(names_from = Variável,
				values_from = Valor) |>
	dplyr::rename('Var. Ac. Ano' = 'IPP - Variação acumulada no ano (em relação a dezembro do ano anterior)',
				  'Var. Mensal Ano Ant.' = 'IPP - Variação mês/mesmo mês do ano anterior (M/M-12)',
				  'Var. Mensal Mês Ant.' = 'IPP - Variação mês/mês imediatamente anterior (M/M-1)',
				  'Índice' = 'IPP - Número-índice (dezembro de 2018 = 100)') |>
	dplyr::mutate(Mês = lubridate::ym(Mês)) #|> as_tsibble(index = Mês)

d4 <- d4 |>
	dplyr::mutate(Categoria,
				  'indg' = case_when(
				  	Categoria=="Indústria geral"~'Geral',
				  	Categoria!="Indústria geral"~'Bens'))

d4 <- d4 |>
	dplyr::mutate(Categoria =
				  	case_when(
				  	Categoria=="Bens de consumo semiduráveis e não duráveis (BCND)"~'BCND',
				  	Categoria=="Bens de consumo duráveis (BCD)"~'BCD',
				  	Categoria=="Bens de capital (BK)"~'BK',
				  	Categoria=="Bens intermediários (BI)"~'BI',
				  	Categoria=="Indústria geral"~'Geral'))
## c5 ---
d5 <- get_sidra(api = c5) |> as_tibble()
d5 <- d5 |>
	dplyr::select('Variável',
				  'Categoria' = 'Indústria geral, indústrias extrativas e indústrias de transformação e atividades (CNAE 2.0)',
				  'Valor') |>
	pivot_wider(names_from = Variável,
				values_from = Valor) |>
	dplyr::rename('Var. Ac. Ano' = 'IPP - Variação acumulada no ano (em relação a dezembro do ano anterior)',
				  'Var. Mensal Ano Ant.' = 'IPP - Variação mês/mesmo mês do ano anterior (M/M-12)',
				  'Var. Mensal Mês Ant.' = 'IPP - Variação mês/mês imediatamente anterior (M/M-1)')|>
	dplyr::relocate('Categoria',
					'Var. Mensal Mês Ant.',
					'Var. Mensal Ano Ant.',
					'Var. Ac. Ano')

d5$Categoria <- str_to_title(d5$Categoria,
							 locale = 'pt')
d5$Categoria <-
	stringr::str_replace_all(d5$Categoria,
						 pattern = ' De ',
						 replacement = ' de ')
d5$Categoria <-
	stringr::str_replace_all(d5$Categoria,
						 pattern = ' E ',
						 replacement = ' e ')
d5$Categoria <-
	stringr::str_replace_all(d5$Categoria,
						 pattern = 'B ',
						 replacement = '0B ')
d5$Categoria <-
	stringr::str_replace_all(d5$Categoria,
						 pattern = 'C ',
						 replacement = '0C ')
d5$Categoria <-
	stringr::str_replace_all(d5$Categoria,
			pattern = 'Indústria Geral',
			replacement = '0A Indústria Geral')
d5$Categoria <-
	stringr::str_replace_all(d5$Categoria,
			pattern = '20b ',
			replacement = '20 ')
d5$Categoria <-
	stringr::str_replace_all(d5$Categoria,
			pattern = '20c ',
			replacement = '20 ')
d5$Categoria <-
	stringr::str_sub(d5$Categoria,
					 start = 4)

```

# Visão Geral


Em construção: 2/8.   
Cronograma de construção do conteúdo:   

   - [ ] Visão Geral
   - [x] Inflação: Consumidor [v1]
   - [x] Inflação: Produtor   [v1]
   - [ ] Produção: Agro 
   - [ ] Produção: Ind 
   - [ ] Produção: Srv 
   - [ ] Emprego
   - [ ] Política Fiscal 
   - [ ] Política Monetária 
   - [ ] Internacional



# Inflação: Consumidor

## Column {data-width="200"}{.tabset .tabset-fade}

### Variação Mensal

```{r}
g1 <- d1 |>
	dplyr::filter(Var == 'Var. mensal') |>
	plot_ly(x = ~Valor,
			y = ~reorder(Local, Valor),
			type = 'bar',
			orientation = 'h',
			text = ~Valor,
			textposition = 'outside',
			color = ~br,
			colors = c('País' = '#117864',
					   'RM' = '#21618c')) |>
	layout(paper_bgcolor = '#f8f8ff',
		   plot_bgcolor = '#f8f8ff',
		   xaxis = list(title = "Var % Mês",
		   			 showgrid = FALSE,
		   			 showline = FALSE,
		   			 showticklabels = FALSE,
		   			 constrain="domain",
		   			 range = c(0,		   			 		  1.1*max(d1$Valor[d1$Var == 'Var. mensal'])),
		   			 zeroline = FALSE),
		   yaxis = list(title = "",
		   			 showticklabels = TRUE),
		   showlegend = FALSE)
config(g1, displaylogo = FALSE,
	   modeBarButtonsToAdd = list('drawopenpath', 'eraseshape'))

```

### Componentes da Inflação no Mês

```{r}
g3 <- plot_ly(data= d3,
			  y= ~reorder(Local,
			  			d1$Valor[
			  			d1$Var=='Var. mensal']),
			  x= ~`1.Alimentação e bebidas`,
			  type = 'bar',
			  orientation = 'h',
			  marker = list(color = 'rgba(38, 24, 74, 0.8)'),
			  line = list(color = 'rgb(248, 248, 249)', width = 1),
			  name='Alimentação')
	
g3 <- g3 |> add_trace(x = ~`2.Habitação`,
					  marker = list(
			color = 'rgba(204, 204, 255, 0.8)'),
			name='Habitação') 
g3 <- g3 |> add_trace(x = ~`3.Artigos de residência`,
					  marker = list(
			color = 'rgba(100, 149, 237, 0.8)'),
			name='Artigos Residenciais') 
g3 <- g3 |> add_trace(x = ~`4.Vestuário`,
					  marker = list(
			color = 'rgba(64, 224, 208, 0.8)'),
			name='Vestuário') 
g3 <- g3 |> add_trace(x = ~`5.Transportes`,
					  marker = list(
			color = 'rgba(159, 226, 191, 0.8)'),
			name='Transporte') 
g3 <- g3 |> add_trace(x = ~`6.Saúde e cuidados pessoais`,
					  marker = list(
			color = 'rgba(222, 49, 99, 0.8)'),
			name='Saúde e cuidados') 
g3 <- g3 |> add_trace(x = ~`7.Despesas pessoais`,
					  marker = list(
			color = 'rgba(255, 127, 80, 0.8)'),
			name='Despesas pessoais') 
g3 <- g3 |> add_trace(x = ~`8.Educação`,
					  marker = list(
			color = 'rgba(255, 191, 0, 0.8)'),
			name='Educação') 
g3 <- g3 |> add_trace(x = ~`9.Comunicação`,
					  marker = list(
			color = 'rgba(223, 255, 0, 0.8)'),
			name='Comunicação') 
g3 <- g3 |>
	layout(xaxis = list(title = "Participação %",
						showgrid = TRUE,
						showline = FALSE,
						showticklabels = FALSE,
						zeroline = FALSE,
						domain = c(0.15, 1)),
		   yaxis = list(title = "",
		   			 showticklabels = T),
		   barmode = 'stack',
		   paper_bgcolor = 'rgb(248, 248, 255)',
		   plot_bgcolor = 'rgb(248, 248, 255)',
		   showlegend = T,
		   legend = list(orientation = 'h')) 
config(g3, displaylogo = FALSE,
	   modeBarButtonsToAdd = list('drawopenpath', 'eraseshape'))
```


## Column {data-width="800"}

### Variações Ac. no Ano {data-height="500"}

```{r, fig.width=9, fig.height=3}
g2 <- d1 |>
	dplyr::filter(Var == 'Var. acumulada no ano') |>
	plot_ly(y = ~Valor,
			x = ~reorder(Local, Valor),
			type = 'bar',
			orientation = 'v',
			color = ~br,
			colors = c('País' = '#117864',
					   'RM' = '#21618c'),
			text = ~Valor,
			textposition = 'outside') |>
	layout(xaxis = list(title = ""),
		   yaxis = list(title = "Var % Ac. Ano",
		   			 showgrid = FALSE,
		   			 showline = FALSE,
		   			 constrain="domain",
		   			 range = c(0,		   			 		  1.125*max(d1$Valor[d1$Var == 'Var. acumulada no ano'])),
		   			 showticklabels = FALSE,
		   			 zeroline = FALSE),
		   paper_bgcolor = '#f8f8ff',
		   plot_bgcolor = '#f8f8ff',
		   showlegend = F)
config(g2, displaylogo = FALSE,
	   modeBarButtonsToAdd = list('drawopenpath', 'eraseshape'))
```

### Variações Ac. em 12 Meses {data-height="500"}

```{r, fig.width=9, fig.height=3}
g4 <- plot_ly(data = d2,
		x= ~Mês,
		y= ~Valor,
		color = ~Local,
		type = 'scatter',
		mode = 'lines')|>
	layout(xaxis = list(title = "",
						showgrid = F),
		   yaxis = list(title = "Var. % Ac. 12 Meses",
		   			 showgrid = T,
		   			 showline = FALSE,
		   			 showticklabels = T,
		   			 zeroline = FALSE),
		   paper_bgcolor = '#f8f8ff',
		   plot_bgcolor = '#f8f8ff',
		   showlegend = T)

config(g4, displaylogo = FALSE,
	   modeBarButtonsToAdd = list('drawopenpath', 'eraseshape'))
```

# Inflação: Produtor

## Column {data-width="400"}

### Variações (%) de Grupos Industriais

```{r}
d51 <- d5
d51$`Var. Ac. Ano` <-
	color_tile("white","steelblue3")(d51$`Var. Ac. Ano`)
d51$`Var. Mensal Mês Ant.` <-
	color_tile("white","steelblue3")(d51$`Var. Mensal Mês Ant.`)
d51$`Var. Mensal Ano Ant.` <-
	color_tile("white","steelblue3")(d51$`Var. Mensal Ano Ant.`)

d51 |>
	kbl(escape = F) |>
	kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
				  font_size = 11) %>%
	row_spec(1:3, bold = T)
```

## Column {data-width="600"}

### Variações (%) {data-height="500"}

```{r}
# G6 plotly -----------------------------------
g6 <- d4 |>
	dplyr::filter(Mês == max(Mês)) |>
	plot_ly(y = ~`Var. Mensal Ano Ant.`,
			x = ~reorder(Categoria, `Var. Mensal Ano Ant.`),
			type = 'bar',
			orientation = 'v',
			color = ~indg,
			colors = c('Geral' = '#21618c',
					   'Bens' = '#117864'),
			text = ~`Var. Mensal Ano Ant.`,
			textposition = 'outside') |>
	layout(title = 'Mês/Mês Ano Ant.',
		xaxis = list(title = ""),
		   yaxis = list(title = "Var% Mês/Mês Ano Ant.",
		   			 showgrid = FALSE,
		   			 showline = FALSE,
		   			 showticklabels = FALSE,
		   			 zeroline = FALSE,
		   			 range = c(0,
		   			 		  1.1*max(d4$`Var. Mensal Ano Ant.`[d4$Mês == max(d4$Mês)]))),
		   paper_bgcolor = '#f8f8ff',
		   plot_bgcolor = '#f8f8ff',
		   showlegend = F)
#g6 <- config(g6,displaylogo = FALSE,
#	   modeBarButtonsToAdd = list('drawopenpath', 'eraseshape'))


# G7 plotly -------------------------------------

g7 <- d4 |>
	dplyr::filter(Mês == max(Mês)) |>
	plot_ly(y = ~`Var. Mensal Mês Ant.`,
			x = ~reorder(Categoria, `Var. Mensal Mês Ant.`),
			type = 'bar',
			orientation = 'v',
			color = ~indg,
			colors = c('Geral' = '#21618c',
					   'Bens' = '#117864'),
			text = ~`Var. Mensal Mês Ant.`,
			textposition = 'outside') |>
	layout(title = 'Mês/Mês Ant.',
		xaxis = list(title = ""),
		   yaxis = list(title = "Var% Mês/Mês Ant.",
		   			 showgrid = FALSE,
		   			 showline = FALSE,
		   			 showticklabels = FALSE,
		   			 zeroline = FALSE,
		   			 range = c(2.1*min(d4$`Var. Mensal Mês Ant.`[d4$Mês == max(d4$Mês)]),
		   			 		  1.1*max(d4$`Var. Mensal Mês Ant.`[d4$Mês == max(d4$Mês)]))),
		   paper_bgcolor = '#f8f8ff',
		   plot_bgcolor = '#f8f8ff',
		   showlegend = F)
#g7 <- config(g7,displaylogo = FALSE,
#	   modeBarButtonsToAdd = list('drawopenpath', 'eraseshape'))


# G8 plotly -------------------------------------

g8 <- d4 |>
	dplyr::filter(Mês == max(Mês)) |>
	plot_ly(y = ~`Var. Ac. Ano`,
			x = ~reorder(Categoria, `Var. Ac. Ano`),
			type = 'bar',
			orientation = 'v',
			color = ~indg,
			colors = c('Geral' = '#21618c',
					   'Bens' = '#117864'),
			text = ~`Var. Ac. Ano`,
			textposition = 'outside') |>
	layout(title = paste('Mês/Mês Ano Ant.',
						 'Mês/Mês Ant.',
						 'Ac. Ano',
						 sep = '                               '),
		xaxis = list(title = ""),
		   yaxis = list(title = "Var% Ac. Ano",
		   			 showgrid = FALSE,
		   			 showline = FALSE,
		   			 showticklabels = FALSE,
		   			 zeroline = FALSE,
		   			 range = c(2.1*min(d4$`Var. Ac. Ano`[d4$Mês == max(d4$Mês)]),
		   			 		  1.1*max(d4$`Var. Ac. Ano`[d4$Mês == max(d4$Mês)]))),
		   paper_bgcolor = '#f8f8ff',
		   plot_bgcolor = '#f8f8ff',
		   showlegend = F)
#g8 <- config(g8,displaylogo = FALSE,
#	   modeBarButtonsToAdd = list('drawopenpath', 'eraseshape'))


# JOIN: G8, G7, G6

g678 <- subplot(g6, g7, g8, nrows = 1)
g678 <- config(g678,
			   displaylogo = FALSE,
			   modeBarButtonsToAdd = list('drawopenpath', 'eraseshape'))
g678
```

### Índice Histórico (2018/Dez = 100) {data-height="500"}

```{r}
g9 <- plot_ly(data = d4,
			  x= ~Mês,
			  y= ~Índice,
			  color = ~Categoria,
			  type = 'scatter',
			  mode = 'lines')|>
	layout(xaxis = list(title = "",
						showgrid = F),
		   yaxis = list(title = "Índice (2018/Dez = 100)",
		   			 showgrid = T,
		   			 showline = FALSE,
		   			 showticklabels = T,
		   			 zeroline = FALSE),
		   paper_bgcolor = '#f8f8ff',
		   plot_bgcolor = '#f8f8ff',
		   showlegend = T)

config(g9, displaylogo = FALSE,
	   modeBarButtonsToAdd = list('drawopenpath', 'eraseshape'))
```



# Produção

# Emprego

# Fiscal

# Internacional
